(function(){angular.module("bookingSystem.imageUploaderDirective",["bookingSystem.imageResizeServices"]).controller("imageUploaderCtrl",["$scope","$q","$element","$attrs","$rootScope","LocationImage","ImageResize","API_IMG_PATH_URL","PHOTO_MISSING_SRC",function($scope,$q,$element,$attrs,$rootScope,LocationImage,ImageResize,API_IMG_PATH_URL,PHOTO_MISSING_SRC){var that=this,i;$scope.file="";$scope.progress=0;$scope.isProgressVisible=false;that.onLoad=function(reader,deferred){return function(){$scope.$apply(function(){ImageResize.scaleImage(reader.result).then(function(imgData){$scope.displayImageSrc=imgData;$scope.base64EncodedImage=imgData.replace(/^data:image\/jpeg;base64,/,"");deferred.resolve()})})}};that.onError=function(reader,deferred){return function(){$scope.$apply(function(){deferred.reject(reader.result)})}};that.onProgress=function(reader){return function(event){}};that.checkFile=function(file){if(file.type=="image/png"||file.type=="image/jpg"||file.type=="image/jpeg"||file.type=="image/gif"){if(file.size<1e7){return true}}};$scope.$watch("imageSrc",function(newValue,oldValue){if(typeof newValue!=="undefined"&&newValue!==""){$scope.displayImageSrc=API_IMG_PATH_URL+newValue+"?"+Date.now()}else{$scope.displayImageSrc=PHOTO_MISSING_SRC}});$scope.readUploadedFile=function(file){var deferred=$q.defer();var reader=new FileReader;if(that.checkFile(file)){reader.onload=that.onLoad(reader,deferred);reader.onerror=that.onError(reader,deferred);reader.onprogress=that.onProgress(reader);reader.readAsDataURL(file);return deferred.promise}else{$rootScope.FlashMessage={type:"error",message:"Den uppladdade bilden måste vara av typen: jpg, gif eller png och får inte överstiga 10mb i storlek"};deferred.reject();return deferred.promise}}}]).directive("imageUploader",["$http",function($http){return{restrict:"E",link:function(scope,elm,attrs){},scope:{imageSrc:"=imageSrc",base64EncodedImage:"=base64EncodedImage"},replace:true,templateUrl:"shared/directives/imageUploaderDirective.html",controller:"imageUploaderCtrl"}}]).directive("imageUploaderFile",function(){return{restrict:"A",replace:false,scope:false,controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$element.bind("change",function(event){var file;file=(event.srcElement||event.target).files[0];$scope.readUploadedFile(file)})}]}})})();