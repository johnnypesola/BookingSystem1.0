(function(){angular.module("bookingSystem.calendarDirective",["bookingSystem.bookingServices","bookingSystem.locationBookingServices","bookingSystem.resourceBookingServices"]).controller("BookingCalendarInternalCtrl",["$scope","$element","$attrs","Booking","LocationBooking","ResourceBooking","$rootScope","$location","$q",function($scope,$element,$attrs,Booking,LocationBooking,ResourceBooking,$rootScope,$location,$q){var that=this,i;that.bookingType=$attrs.bookingType;that.declareTypeOfBookingService=function(){if(that.bookingType=="booking"){that.typeOfBookingService=Booking}else if(that.bookingType=="location-booking"){that.typeOfBookingService=LocationBooking}else if(that.bookingType=="resource-booking"){that.typeOfBookingService=ResourceBooking}};that.updateSelectedDateIfNeeded=function(){if(typeof that.selectedMonth=="undefined"||typeof that.selectedDay=="undefined"){that.selectedMonth=$location.search().manad;that.selectedDay=$location.search().dag}};that.initDateVariables=function(){var yearParam=$location.search().ar;var monthParam=$location.search().manad;var dayParam=$location.search().dag||1;if(typeof yearParam!=="undefined"&&typeof monthParam!=="undefined"){that.currentDateObj=moment(yearParam+"-"+$BookSysUtil.String.addLeadingZero(monthParam)+"-"+$BookSysUtil.String.addLeadingZero(dayParam)).toDate()}else{that.currentDateObj=new Date;that.setDefaultUrlParams()}that.updateSelectedDateIfNeeded();that.currentYear=that.currentDateObj.getFullYear();that.currentMonth=that.currentDateObj.getMonth();that.currentMonthName=moment(that.currentDateObj).format("MMMM");that.currentMonthDay=that.currentDateObj.getDate();that.currentMonthDayName=moment(that.currentDateObj).format("dddd");that.currentMonthNumberOfDays=moment(that.currentDateObj).daysInMonth();that.currentMonthStartDateObj=new Date(that.currentYear,that.currentMonth,1);that.currentMonthEndDateObj=new Date(that.currentYear,that.currentMonth,that.currentMonthNumberOfDays);that.currentMonthStartWeekDay=that.currentMonthStartDateObj.getDay()===0?7:that.currentMonthStartDateObj.getDay();that.currentMonthEndWeekDay=that.currentMonthEndDateObj.getDay()===0?7:that.currentMonthEndDateObj.getDay();that.prevMonthNumberOfDays=new Date(that.currentYear,that.currentMonth,0).getDate();$scope.dateHeaderString=moment(that.currentDateObj).format("dddd, Do MMMM YYYY")};that.isSelectedDay=function(dayNumber){return+that.selectedMonth===+that.currentMonth+1&&+that.selectedDay===dayNumber};that.dayHasBookings=function(dayNumber){if(typeof dayNumber!=="undefined"){var monthNumber;dayNumber=$BookSysUtil.String.addLeadingZero(dayNumber);monthNumber=$BookSysUtil.String.addLeadingZero(that.currentMonth+1);var startOfDay=moment(that.currentYear+"-"+monthNumber+"-"+dayNumber+" 00:00").toDate();var endOfDay=moment(that.currentYear+"-"+monthNumber+"-"+dayNumber+" 23:59").toDate();return that.bookingsForMonthArray.some(function(element){return element.StartTime>=startOfDay&&element.StartTime<=endOfDay||element.EndTime>=startOfDay&&element.EndTime<=endOfDay||element.StartTime<startOfDay&&element.EndTime>endOfDay})}};that.prepareCalendarDays=function(){that.calendarDaysArray=[];for(i=1;i<that.currentMonthStartWeekDay;i++){that.calendarDaysArray.push({number:that.prevMonthNumberOfDays-(that.currentMonthStartWeekDay-i-1),cssClassName:"inactive"})}for(i=1;i<=that.currentMonthNumberOfDays;i++){that.calendarDaysArray.push({number:i,cssClassName:that.isSelectedDay(i)?"active":that.dayHasBookings(i)?"has-events":""})}for(i=1;i<=7-that.currentMonthEndWeekDay;i++){that.calendarDaysArray.push({number:i,cssClassName:"inactive"})}};that.getBookingsForMonth=function(){var deferred=$q.defer(),promise=deferred.promise;that.bookingsForMonthArray=that.typeOfBookingService.queryLessForPeriod({fromDate:moment(that.currentMonthStartDateObj).format("YYYY-MM-DD"),toDate:moment(that.currentMonthEndDateObj).format("YYYY-MM-DD")});that.bookingsForMonthArray.$promise.catch(function(){$rootScope.FlashMessage={type:"error",message:"Bokningarna kunde inte hämtas, var god försök igen."}});that.bookingsForMonthArray.$promise.then(function(){deferred.resolve()});return promise};that.addVarsToScope=function(){$scope.datedata={currentYear:that.currentYear,currentMonth:that.currentMonth,currentMonthName:that.currentMonthName,currentDayName:that.currentMonthDayName,currentMonthNumberOfDays:that.currentMonthNumberOfDays,calendarDays:that.calendarDaysArray}};that.setDefaultUrlParams=function(){if(typeof $location.search().ar==="undefined"&&typeof $location.search().manad==="undefined"&&typeof $location.search().dag==="undefined"){$location.search("ar",moment().format("YYYY"));$location.search("manad",moment().format("M"));$location.search("dag",moment().format("D"))}};that.updateCalendarContent=function(){var deferred=$q.defer(),promise=deferred.promise;that.initDateVariables();that.getBookingsForMonth().then(function(){$BookSysUtil.Date.convertStringsToDates(that.bookingsForMonthArray);that.prepareCalendarDays();that.addVarsToScope();deferred.resolve()});return promise};that.getDataForDay=function(){var bookings;bookings=that.typeOfBookingService.queryMoreForPeriod({fromDate:moment(that.currentDateObj).format("YYYY-MM-DD"),toDate:moment(that.currentDateObj).format("YYYY-MM-DD")});bookings.$promise.catch(function(){$rootScope.FlashMessage={type:"error",message:"Bokningarna kunde inte hämtas, var god försök igen."}});$scope.datedata.bookings=bookings};$scope.changeToPreviousMonth=function(){if(that.currentMonth==0){that.currentMonth=12;that.currentYear-=1}$location.search("ar",that.currentYear);$location.search("manad",that.currentMonth);$location.search("dag",null);that.updateCalendarContent()};$scope.changeToNextMonth=function(){if(that.currentMonth==11){that.currentYear+=1;that.currentMonth=-1}$location.search("ar",that.currentYear);$location.search("manad",that.currentMonth+2);$location.search("dag",null);that.updateCalendarContent()};$scope.changeToDay=function($element,$attrs,event){var clickedDayElement=angular.element(event.target);if(!clickedDayElement.hasClass("inactive")){that.currentDateObj=new Date(that.currentYear,that.currentMonth,$attrs.number);$location.search("dag",$attrs.number);that.selectedMonth=$location.search().manad;that.selectedDay=$location.search().dag;event.preventDefault();that.initDateVariables();that.prepareCalendarDays();that.addVarsToScope();that.getDataForDay()}};that.declareTypeOfBookingService();that.updateCalendarContent().then(function(){that.getDataForDay()})}]).directive("bookingCalendar",["Booking",function(Booking){return{restrict:"E",replace:true,templateUrl:function(element,attr){if(attr.bookingType=="booking"){return"shared/directives/calendarDirectiveBooking.html"}else if(attr.bookingType=="location-booking"){return"shared/directives/calendarDirectiveLocationBooking.html"}else if(attr.bookingType=="resource-booking"){return"shared/directives/calendarDirectiveResourceBooking.html"}},scope:true,link:function(){},controller:"BookingCalendarInternalCtrl"}}]).directive("changeMonthButton",function(){return{restrict:"A",replace:false,scope:false,link:function(scope,element,attr){element.bind("mousedown",function(e){e.preventDefault()})},controller:["$scope","$element","$attrs",function($scope,$element,$attrs){if($attrs.direction==="next"){$element.bind("click",function(){$scope.changeToNextMonth();$scope.$digest()})}else if($attrs.direction==="prev"){$element.bind("click",function(){$scope.changeToPreviousMonth();$scope.$digest()})}}]}}).directive("bookingCalendarDay",function(){return{restrict:"A",replace:false,scope:false,controller:["$scope","$element","$attrs",function($scope,$element,$attrs){$element.bind("click",function(event){$scope.changeToDay($element,$attrs,event)})}]}})})();